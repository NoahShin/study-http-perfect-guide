# 내용 협상이 무엇이냐

예를 들어 우리 사이트의 주 고객이 영어 사용자와 프랑스어 사용자 양측이 존재한다면, 우리는 사용자에 맞게 콘텐츠를 제공해줘야 한다. 

HTTP는 이런 판단이 가능하게 내용협상이란 방법을 제공한다.

이 방법은 하나의 URL이 여러 가지 리소스 중 적합한 것을 제공하도록 할 수 있다. 여기서는 서로 다른 버전을 배리언트( Variant ) 라고 부른다


# 요약 테이블
![](https://images.velog.io/images/noahshin__11/post/ca865eb1-61e3-4953-bb6e-ccf76ca7f333/image.png)

![](https://images.velog.io/images/noahshin__11/post/552bad74-19d4-4a94-9ebf-aac0be77613e/image.png)

# 투명 협상
투명 협상은 중간에 프락시를 두면서 클라이언트와의 메시지 교환을 최소화하는 동시에 서버 주도 협상으로 인한 부하를 서버에서 제거한다.

프락시는 클라이언트의 기대를 파악하고, 클라이언트와 협상할 수 있는 능력이 있다고 간주되는데, 서버는 프락시에게 Vary 헤더를 통해 어떤 조건을 확인해야 하는지를 알려줄 수 있다.


 
캐시 프락시가 만일 서버의 의사결정 프로세스를 알게 된다면, 캐시는 서버의 입장에서 협상을 진행할 수도 있다.

### 캐시와 얼터네이트 ( alternate )
캐시는 클라이언트에게 올바른 응답을 주기 위해 서버가 응답을 돌려줄 때 사용했던 의사결정 로직의 상당부분을 그대로 사용해야 한다.

캐시는 똑같은 리소스에 대하여 다른 버전을 동시에 가질 수 있도록, 이번의 응답과 저번의 응답을 모두 저장한다.

![](https://images.velog.io/images/noahshin__11/post/2420f326-075f-47d7-90f4-d7156a8b2a38/image.png)

### Vary 헤더
제공된 문서가 의존하고 있는 헤더를 포함하여 돌려준다.

캐시는 각 배리언트마다 알맞은 문서 버전을 저장해야 한다. 캐시가 검색을 할 때 먼저 내용 협상 헤더로 적합한 콘텐츠를 맞춰보고, 요청의 배리언트를 캐시된 배리언트와 맞춰본다.

맞는 것이 없다면 서버에서 가져온다.

![](https://images.velog.io/images/noahshin__11/post/06bda1a9-41c7-4cce-89dc-b3601acd6504/image.png)
![](https://images.velog.io/images/noahshin__11/post/8ae309a7-1213-4924-b8fd-0adfd0614157/image.png)

# 트랜스 코딩

## 무엇?

- 서버가 클라이언트의 요구에 맞는 문서를 하나도 갖고 있지 않다면, 기존의 문서를 클라이언트가 사용할 수 있는 무언가로 변환하는 옵션

- 포맷 변환
- 정보 합성
- 내용 주입

![](https://images.velog.io/images/noahshin__11/post/7cf7929f-8bc8-4cc6-8c29-6b87eab5d567/image.png)

## 포맷 변환
- 데이터를 클라이언트가 다른 환경에서도 볼수 있도록 포맷 변환 시켜주는 것
- 내용 협상 헤더에 의해 주도된다ㅣ. (user-agent header에 의해서 주도될 수도 있다)
- 내용 변환 & 트랜스 코딩 = 콘텐츠를 특정 접근 장치에서 볼 수 있도록 하기 위한
- 콘텐츠 인코딩 & 전송 인코딩 = 콘텐츠를 더 효율적이거나 안전한 전송을 위한

## 정보 합성

- 보통 포털 사이트의 웹페이지 디렉터리와 같은 자동화된 웹페이지 분류 시스템에 의해 종종 사용된다.

## 내용 주입

이제까지는 다 뭔가 줄이는 거였는데 이거는 오히려 양을 늘리는 편

지나가는 HTML 페이지에 자동으로 광고 삽입이나 특정 사용자를 대상으로 하는 광고를 그때 그때 효과적으로 삽입하기 위해 동적으로 이루어 진다. (광고 알고리즘...?)

![](https://images.velog.io/images/noahshin__11/post/4239182e-9f73-4366-897d-e269c7b6bb79/image.png)


## 트랜스코딩 vs 정적으로 미리 생성해 놓기

- 트랜스코딩의 대안은 웹서버에 여러가지 사본을 만드는 것
근데 이 방식은 페이지에 대한 어떠한 작은 변화도 여러 페이지의 수정을 요구하고
각 페이지의 모든 버전을 저장하기 위해 많은 공간이 필요

광고 삽입과 같은 몇몇 트랜스 코딩은 정적인 방법으로는 수행할 수 없는데, 이는 페이지를 요청한 사용자에게 달려 있기 때문.